!function(a){var b=function(){var b,c,d,e,f=this,g="";f.settings={breakpoint:"700",heading_1_tag:"h3",heading_2_tag:"h4",controls:["bold","italics","underline","heading_1","heading_2","quote","link"]},f.init=function(c,d){f.settings=a.extend(f.settings,d),b=c,$this_penplate_content=jQuery.trim(b.html()),f.add_controls(),b.find("p:first").addClass("first-paragraph"),0==b.find("p:first").hasClass("first-paragraph")&&b.html("<p>"+$this_penplate_content+"</p>"),b.attr({contenteditable:"true"}),document.execCommand("defaultParagraphSeparator",!1,"p"),f.window_type(),a(window).resize(function(){f.window_type()}),f.new_paragraph(),f.window_resize(),f.activate_controls(b),f.link_control()},f.add_controls=function(){d={bold:'<li><a href="#" data-pen-edit="text-bold">B</a></li>',italics:'<li><a href="#" data-pen-edit="text-italic">I</a></li>',underline:'<li><a href="#" data-pen-edit="text-underline">U</a></li>',heading_1:'<li><a href="#" data-pen-edit="format-'+f.settings.heading_1_tag+'">H1</a></li>',heading_2:'<li><a href="#" data-pen-edit="format-'+f.settings.heading_2_tag+'">H2</a></li>',quote:'<li><a href="#" data-pen-edit="format-blockquote" class="img-quote">Quote</a></li>',link:'<li><a href="#" data-pen-edit="custom-link" class="img-link">Link</a></li>',image:'<li><a href="#" data-pen-edit="custom-image" class="img-image">Image</a></li>'},g+='<div class="penplate-controls">',g+='<div class="penplate-link">',g+='<div class="input-container"><input type="text" value="" placeholder="Your link..." /></div>',g+='<a href="#" data-pen-edit="custom-link-cancel" class="link-cancel">Cancel</a>',g+="</div>",g+="<ul>",a.each(f.settings.controls,function(a,b){g+=d[b]}),g+="</ul></div>",0===a("body .penplate-controls").length&&(a("body").append(g),f.edit_selection())},f.window_type=function(){a(window).width()<=f.settings.breakpoint?(a("html").addClass("penplate-small-view"),a("html").removeClass("penplate-large-view"),c="small-view",f.reset_position()):(a("html").removeClass("penplate-small-view"),a("html").addClass("penplate-large-view"),c="large-view")},f.reset_position=function(){a(".penplate-controls").css({top:"0",left:"0"})},f.activate_controls=function(b){b.on("mouseup",function(){f.check_selection()}),b.on("keyup",function(){f.check_selection()}),a("html").on("click",function(b){var c=a(b.target),d=c.parents(".penplate-controls").length;0==d&&f.hide_controls(),a(window).resize(function(){f.hide_controls()})})},f.restore_selection=function(a){if(a)for($selection.removeAllRanges(),i=0,len=a.length;len>i;i+=1)$selection.addRange(a[i])},f.check_selection=function(){if($selection=window.getSelection(),$range=$selection.getRangeAt(0),$range_start=$range.startOffset,$range_end=$range.endOffset,$is_range=!1,$selection){if($selection=window.getSelection(),$selection.getRangeAt&&$selection.rangeCount){for(var a=[],b=0,c=$selection.rangeCount;c>b;++b)a.push($selection.getRangeAt(b));e=a}}else document.selection&&document.selection.createRange&&(e=document.selection.createRange());$range_end-$range_start!=0&&($is_range=!0),1==$is_range&&f.show_controls()},f.show_controls=function(){f.set_control_position(),0==a("html").hasClass("show-penplate-controls")&&a("html").addClass("show-penplate-controls"),a(".penplate-controls").bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){1==a("html").hasClass("show-penplate-controls")&&a("html").addClass("penplate-controls-open")})},f.hide_controls=function(){a("html").hasClass("show-penplate-controls")&&a("html").hasClass("penplate-controls-open")&&(a("html").removeClass("show-penplate-controls").removeClass("penplate-controls-open"),f.link_input_hide(),"large-view"==c&&a(".penplate-controls").css({top:"-100px"}))},f.set_control_position=function(){"large-view"==c&&($control_w=a(".penplate-controls").outerWidth(),$control_h=a(".penplate-controls").height(),$selection=window.getSelection(),$range=$selection.getRangeAt(0),$boundary=$range.getBoundingClientRect(),$boundary_center=($boundary.left+$boundary.right)/2,$offset_left=$boundary_center-$control_w/2,$offset_top=$boundary.top+window.pageYOffset-($control_h+12),a(".penplate-controls").css({left:$offset_left,top:$offset_top}))},f.edit_selection=function(){a(".penplate-controls a").on("click",function(b){b.preventDefault(),$this=a(this),$pen_edit=$this.data("pen-edit"),$ex_pen_edit=$pen_edit.split("-"),$pen_edit_type=$ex_pen_edit[0],$pen_edit_action=$ex_pen_edit[1],"text"==$pen_edit_type?document.execCommand($pen_edit_action):"format"==$pen_edit_type&&($parent_tag_type=f.get_parent_tag_type(),$parent_tag_type!=$pen_edit_action?($super_parent=window.getSelection().anchorNode.parentElement.parentElement.nodeName.toLowerCase(),"blockquote"==$pen_edit_action?(document.execCommand("outdent",!1,null),"blockquote"!=$super_parent&&document.execCommand("formatBlock",!1,$pen_edit_action)):document.execCommand("formatBlock",!1,$pen_edit_action)):document.execCommand("formatBlock",!1,"p")),setTimeout(function(){f.set_control_position()},1)}),a(".penplate-controls .penplate-link input").on("keyup",function(b){13===b.keyCode&&(b.preventDefault(),$link_input_val=a(this).val(),f.restore_selection(e),document.execCommand("createLink",!1,$link_input_val),f.hide_controls(),a(this).val(""))})},f.get_parent_tag_type=function(){return $crt_selection=window.getSelection(),$crt_selection.anchorNode.parentElement.nodeName.toLowerCase()},f.new_paragraph=function(){b.on("keypress",function(a){"13"==a.keyCode&&setTimeout(function(){document.execCommand("formatBlock",!1,"p")},10)})},f.window_resize=function(){a(window).on("resize",function(){f.window_type()})},f.link_control=function(){a(".penplate-controls a.img-link").on("click",function(){f.link_input_show()}),a(".penplate-controls .link-cancel").on("click",function(a){a.preventDefault(),f.link_input_hide(),f.restore_selection(e)})},f.link_input_show=function(){a(".penplate-controls ul").hide(),a(".penplate-controls .penplate-link").fadeIn("fast",function(){a(".penplate-controls .penplate-link input").focus()})},f.link_input_hide=function(){a(".penplate-controls ul").fadeIn(),a(".penplate-controls .penplate-link").hide()}};a.fn.penplate=function(c){var d=this.length;return this.each(function(e){var f=a(this),g="penplate"+(d>1?"-"+ ++e:""),h=(new b).init(f,c);f.data(g,h).data("key",g)})}}(jQuery);