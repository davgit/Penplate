!function(a){var b=function(){var b,c,d=this;d.settings={breakpoint:"700"},d.init=function(c,e){d.settings=a.extend(d.settings,e),b=c,$this_penplate_content=jQuery.trim(b.html()),b.find("p:first").addClass("first-paragraph"),0==b.find("p:first").hasClass("first-paragraph")&&b.html("<p>"+$this_penplate_content+"</p>"),b.attr({contenteditable:"true"}),document.execCommand("defaultParagraphSeparator",!1,"p"),d.window_type(),a(window).resize(function(){d.window_type()}),d.new_paragraph(),d.edit_selection(),d.activate_controls(b),d.window_resize()},d.window_type=function(){a(window).width()<=d.settings.breakpoint?(a("html").addClass("penplate-small-view"),a("html").removeClass("penplate-large-view"),c="small-view",d.reset_position()):(a("html").removeClass("penplate-small-view"),a("html").addClass("penplate-large-view"),c="large-view")},d.reset_position=function(){a(".penplate-controls").css({top:"0",left:"0"})},d.activate_controls=function(b){a("html").on("mouseup",function(){d.check_selection()}),b.on("keyup",function(){d.check_selection()}),a("html").on("click",function(b){var c=a(b.target),e=c.parents(".penplate-controls").length;0==e&&d.hide_controls(),a(window).resize(function(){d.hide_controls()})})},d.check_selection=function(){$selection=window.getSelection(),"Range"==$selection.type&&d.show_controls()},d.show_controls=function(){d.set_control_position(),0==a("html").hasClass("show-penplate-controls")&&a("html").addClass("show-penplate-controls"),a(".penplate-controls").bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){1==a("html").hasClass("show-penplate-controls")&&a("html").addClass("penplate-controls-open")})},d.hide_controls=function(){a("html").hasClass("show-penplate-controls")&&a("html").hasClass("penplate-controls-open")&&(a("html").removeClass("show-penplate-controls").removeClass("penplate-controls-open"),"large-view"==c&&a(".penplate-controls").css({top:"-100px"}))},d.set_control_position=function(){"large-view"==c&&($control_w=a(".penplate-controls").outerWidth(),$control_h=a(".penplate-controls").height(),$selection=window.getSelection(),$range=$selection.getRangeAt(0),$boundary=$range.getBoundingClientRect(),$boundary_center=($boundary.left+$boundary.right)/2,$offset_left=$boundary_center-$control_w/2,$offset_top=$boundary.top+window.pageYOffset-($control_h+12),a(".penplate-controls").css({left:$offset_left,top:$offset_top}))},d.edit_selection=function(){a(".penplate-controls a").on("click",function(b){b.preventDefault(),$this=a(this),$pen_edit=$this.data("pen-edit"),$ex_pen_edit=$pen_edit.split("-"),$pen_edit_type=$ex_pen_edit[0],$pen_edit_action=$ex_pen_edit[1],"text"==$pen_edit_type?document.execCommand($pen_edit_action):"format"==$pen_edit_type&&($parent_tag_type=d.get_parent_tag_type(),$parent_tag_type!=$pen_edit_action?($super_parent=window.getSelection().anchorNode.parentElement.parentElement.nodeName.toLowerCase(),"blockquote"==$pen_edit_action?(document.execCommand("outdent",!1,null),"blockquote"!=$super_parent&&document.execCommand("formatBlock",!1,$pen_edit_action)):document.execCommand("formatBlock",!1,$pen_edit_action)):document.execCommand("formatBlock",!1,"p")),setTimeout(function(){d.set_control_position()},30)})},d.get_parent_tag_type=function(){return $crt_selection=window.getSelection(),$crt_selection.anchorNode.parentElement.nodeName.toLowerCase()},d.new_paragraph=function(){b.on("keypress",function(a){"13"==a.keyCode&&setTimeout(function(){document.execCommand("formatBlock",!1,"p")},10)})},d.window_resize=function(){a(window).on("resize",function(){d.window_type()})}};a.fn.penplate=function(c){var d=this.length;return this.each(function(e){var f=a(this),g="penplate"+(d>1?"-"+ ++e:""),h=(new b).init(f,c);f.data(g,h).data("key",g)})}}(jQuery);